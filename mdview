#!/usr/bin/env bash

# mdview - Markdown + Mermaid viewer for terminal
# Displays Markdown files with inline Mermaid diagrams converted to images

set -euo pipefail

# ========================================
# エラーハンドリング
# ========================================
if ! command -v mdcat &>/dev/null; then
  echo "Error: mdcat is not installed. Install with: brew install mdcat" >&2
  exit 1
fi

if ! command -v mmdc &>/dev/null; then
  echo "Error: mermaid-cli is not installed. Install with: npm install -g @mermaid-js/mermaid-cli" >&2
  exit 1
fi

if [[ $# -eq 0 ]]; then
  echo "Usage: mdview <markdown-file>" >&2
  exit 1
fi

if [[ ! -f "$1" ]]; then
  echo "Error: File '$1' not found" >&2
  exit 1
fi

# ========================================
# 変数設定
# ========================================
INPUT_FILE="$1"
TEMP_DIR=$(mktemp -d)
TEMP_MD="${TEMP_DIR}/processed.md"
DIAGRAM_COUNTER=0

# クリーンアップ関数
cleanup() {
  rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

# ========================================
# Markdown処理（Mermaid + コードブロック）
# ========================================
process_markdown() {
  local in_code_block=false
  local code_language=""
  local code_content=""
  local line_buffer=""

  while IFS= read -r line || [[ -n "$line" ]]; do
    # コードブロック内の処理
    if $in_code_block; then
      if [[ "$line" =~ ^\`\`\`[[:space:]]*$ ]]; then
        # コードブロック終了
        if [[ "$code_language" == "mermaid" ]]; then
          # Mermaid画像に変換
          DIAGRAM_COUNTER=$((DIAGRAM_COUNTER + 1))
          local mermaid_file="${TEMP_DIR}/diagram_${DIAGRAM_COUNTER}.mmd"
          local png_file="${TEMP_DIR}/diagram_${DIAGRAM_COUNTER}.png"

          # Mermaidファイルを作成
          echo "$code_content" > "$mermaid_file"

          # PNG画像に変換（透明背景）
          local mmdc_output
          if mmdc_output=$(mmdc -i "$mermaid_file" -o "$png_file" -b transparent -t dark 2>&1); then
            # Mermaid画像参照を追加
            echo "![Mermaid Diagram ${DIAGRAM_COUNTER}](${png_file})"
            echo ""
          else
            # 変換失敗時は元のコードブロックを出力
            echo "Warning: Mermaid diagram ${DIAGRAM_COUNTER} conversion failed" >&2
            echo "$mmdc_output" >&2
            echo '```mermaid'
            echo -n "$code_content"
            echo '```'
            echo ""
          fi
        else
          # 通常のコードブロック終了
          echo -n "$code_content"
          echo '```'
          echo ""
        fi

        in_code_block=false
        code_language=""
        code_content=""
      else
        # コードコンテンツを蓄積
        code_content+="${line}"$'\n'
      fi
    # コードブロック開始を検出（```言語名）
    elif [[ "$line" =~ ^\`\`\`([a-zA-Z0-9_+-]*) ]]; then
      code_language="${BASH_REMATCH[1]}"

      if [[ "$code_language" == "mermaid" ]]; then
        # Mermaidブロック開始
        printf '%s' "$line_buffer"
        line_buffer=""
        in_code_block=true
        code_content=""
        continue
      elif [[ -n "$code_language" ]]; then
        # 通常のコードブロック開始
        printf '%s' "$line_buffer"
        line_buffer=""
        # 言語名を大文字に変換して区切り線に表示
        local lang_upper=$(echo "$code_language" | tr '[:lower:]' '[:upper:]')
        echo ""
        echo "--${lang_upper}-------------------------------------"
        echo ""
        echo "\`\`\`${code_language}"
        in_code_block=true
        code_content=""
        continue
      else
        # 言語名なしのコードブロック
        printf '%s' "$line_buffer"
        line_buffer=""
        echo ""
        echo "--CODE-------------------------------------"
        echo ""
        echo "\`\`\`"
        in_code_block=true
        code_language="code"
        code_content=""
        continue
      fi
    else
      # 通常の行をバッファに追加
      line_buffer+="${line}"$'\n'
    fi
  done < "$INPUT_FILE"

  # 残りのバッファを出力
  echo -n "$line_buffer"
}

# ========================================
# メイン処理
# ========================================
process_markdown > "$TEMP_MD"

# mdcatで表示（画像もインライン表示）
mdcat "$TEMP_MD"
